<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Planner - AI-Powered Automation Assistant</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
    <script src="config.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="main-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FF8C00" style="width: 1.15em; height: 1.15em; margin-right: 0.15em; vertical-align: text-bottom;">
                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                </svg>
                n8n Workflow Builder
            </h1>
        </header>
        
        <div class="input-section">
            <div class="input-wrapper">
                <textarea 
                    id="userInput" 
                    class="main-input" 
                    placeholder="What are you trying to automate?"
                    rows="4"
                ></textarea>
                <div class="button-group">
                    <button id="voiceBtn" class="voice-btn" type="button" title="Click to start voice input">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor" class="mic-icon">
                            <path d="M192 0C139 0 96 43 96 96V256c0 53 43 96 96 96s96-43 96-96V96c0-53-43-96-96-96zM64 216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 89.1 66.2 162.7 152 174.4V464H120c-13.3 0-24 10.7-24 24s10.7 24 24 24h72 72c13.3 0 24-10.7 24-24s-10.7-24-24-24H216V430.4c85.8-11.7 152-85.3 152-174.4V216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 70.7-57.3 128-128 128s-128-57.3-128-128V216z"/>
                        </svg>
                    </button>
                    <button id="mcpBtn" class="mcp-btn" type="button" aria-pressed="false" title="Toggle MCP tools (off by default)">MCPs Off</button>
                    <button id="submitBtn" class="submit-btn" type="button">Create Workflow Plan</button>
                </div>
            </div>
            
            <div class="suggestions">
                <button class="suggestion-btn" data-suggestion="Invoice Processing Pipeline">Invoice Processing Pipeline</button>
                <button class="suggestion-btn" data-suggestion="Daily AI News Digest">Daily AI News Digest</button>
                <button class="suggestion-btn" data-suggestion="RAG Knowledge Assistant">RAG Knowledge Assistant</button>
                <button class="suggestion-btn" data-suggestion="Summarize Emails with AI">Summarize Emails with AI</button>
                <button class="suggestion-btn" data-suggestion="UGC Creator">UGC Creator</button>
                <button class="suggestion-btn" data-suggestion="Automated Blog Writer">Automated Blog Writer</button>
                <button class="suggestion-btn" data-suggestion="Lead Qualification and Call Scheduling">Lead Qualification and Call Scheduling</button>
                <button class="suggestion-btn" data-suggestion="Multi-agent Research Workflow">Multi-agent Research Workflow</button>
            </div>
        </div>
        
        <!-- Chat Interface (hidden by default) -->
        <div class="chat-interface" id="chatInterface" style="display: none;">
            <div class="chat-header">
                <h2>n8n Workflow Builder Chat</h2>
                <button class="back-btn" id="backBtn">‚Üê Back to Start</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be dynamically added here -->
            </div>
            <div class="chat-input-wrapper">
                <textarea 
                    id="chatInput" 
                    class="chat-input" 
                    placeholder="Type your message..."
                    rows="2"
                ></textarea>
                <div class="chat-button-group">
                    <span id="mcpStatusIndicator" class="mcp-status-indicator"></span>
                    <button id="chatVoiceBtn" class="chat-voice-btn" type="button" title="Click to start voice input">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor" class="mic-icon">
                            <path d="M192 0C139 0 96 43 96 96V256c0 53 43 96 96 96s96-43 96-96V96c0-53-43-96-96-96zM64 216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 89.1 66.2 162.7 152 174.4V464H120c-13.3 0-24 10.7-24 24s10.7 24 24 24h72 72c13.3 0 24-10.7 24-24s-10.7-24-24-24H216V430.4c85.8-11.7 152-85.3 152-174.4V216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 70.7-57.3 128-128 128s-128-57.3-128-128V216z"/>
                        </svg>
                    </button>
                    <button id="sendBtn" class="send-btn">Send</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="loading-text" id="loadingText">The AI workflow builder is thinking...</p>
        </div>
    </div>
    
    <!-- Diagram Modal -->
    <div class="modal" id="diagramModal">
        <div class="modal-content">
            <span class="modal-close" id="modalClose">&times;</span>
            <div class="modal-header">
                <h3>Workflow Diagram</h3>
            </div>
            <div class="modal-actions">
                <button class="download-btn" id="downloadPng">Download PNG</button>
                <button class="download-btn" id="downloadSvg">Download SVG</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Diagram will be inserted here -->
            </div>
        </div>
    </div>
    
    <!-- Dynamic App Loading: Load app-original.js or app-mcp.js based on MCP toggle -->
    <script>
        // MCP toggle handler - setup FIRST before loading app
        console.log('üîß Setting up MCP toggle handler...');

        // Update button visual state based on current setting
        function updateMcpButtonState() {
            const mcpBtn = document.getElementById('mcpBtn');
            if (!mcpBtn) {
                console.error('‚ùå MCP button not found in DOM');
                return false;
            }

            const isEnabled = localStorage.getItem('mcpEnabled') === 'true';
            if (isEnabled) {
                mcpBtn.classList.add('active');
                mcpBtn.setAttribute('aria-pressed', 'true');
                mcpBtn.textContent = 'MCPs On';
            } else {
                mcpBtn.classList.remove('active');
                mcpBtn.setAttribute('aria-pressed', 'false');
                mcpBtn.textContent = 'MCPs Off';
            }
            console.log(`üé® Button state updated: ${isEnabled ? 'ON' : 'OFF'}`);
            return true;
        }

        // Setup MCP button click handler
        function setupMcpButtonHandler() {
            const mcpBtn = document.getElementById('mcpBtn');
            if (!mcpBtn) {
                console.error('‚ùå Cannot find MCP button');
                return false;
            }

            console.log('‚úÖ Attaching MCP button click handler...');

            mcpBtn.onclick = function(e) {
                console.log('üñ±Ô∏è MCP button CLICKED!');
                e.preventDefault();
                e.stopPropagation();

                // Toggle the setting
                const currentState = localStorage.getItem('mcpEnabled') === 'true';
                const newState = !currentState;

                console.log(`üîÑ Toggling from ${currentState} to ${newState}`);

                // Save state before reload (for conversation preservation)
                if (window.saveStateForToggle) {
                    console.log('üíæ Saving state before toggle...');
                    window.saveStateForToggle();
                } else {
                    console.warn('‚ö†Ô∏è saveStateForToggle not available yet');
                }

                try {
                    localStorage.setItem('mcpEnabled', String(newState));
                    console.log(`‚úÖ localStorage updated: mcpEnabled = ${newState}`);
                } catch (err) {
                    console.error('‚ùå Failed to update localStorage:', err);
                    alert('Failed to save MCP setting. Check browser privacy settings.');
                    return;
                }

                // Reload page to switch app files
                console.log(`üîÑ Reloading to switch to ${newState ? 'app-mcp.js' : 'app-original.js'}...`);
                setTimeout(function() {
                    window.location.reload();
                }, 150);
            };

            console.log('‚úÖ MCP button handler attached successfully');
            return true;
        }

        // Initialize MCP button
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üìã DOM ready, setting up MCP button...');
                updateMcpButtonState();
                setupMcpButtonHandler();
            });
        } else {
            console.log('üìã DOM already ready, setting up MCP button...');
            updateMcpButtonState();
            setupMcpButtonHandler();
        }

        // MCP Status Indicator for Chat Mode
        // Update MCP status indicator in chat
        function updateMcpStatusIndicator() {
            const indicator = document.getElementById('mcpStatusIndicator');
            if (indicator) {
                const isEnabled = localStorage.getItem('mcpEnabled') === 'true';
                indicator.textContent = isEnabled ? 'MCPs On' : 'MCPs Off';
                indicator.classList.toggle('active', isEnabled);
                console.log(`üéØ MCP status indicator updated: ${isEnabled ? 'ON' : 'OFF'}`);
            }
        }

        // Update indicator when chat interface becomes visible
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.target.id === 'chatInterface' &&
                    mutation.target.style.display !== 'none') {
                    updateMcpStatusIndicator();
                }
            });
        });

        // Start observing when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                const chatInterface = document.getElementById('chatInterface');
                if (chatInterface) {
                    observer.observe(chatInterface, {
                        attributes: true,
                        attributeFilter: ['style']
                    });
                }
            });
        } else {
            const chatInterface = document.getElementById('chatInterface');
            if (chatInterface) {
                observer.observe(chatInterface, {
                    attributes: true,
                    attributeFilter: ['style']
                });
            }
        }

        // Load the appropriate app script
        // Default to MCPs OFF on first load
        const firstLoadKey = 'workflowPlannerInitialized';
        const isFirstLoad = localStorage.getItem(firstLoadKey) === null;

        if (isFirstLoad) {
            console.log('üÜï First load: Setting MCPs to OFF by default');
            localStorage.setItem('mcpEnabled', 'false');
            localStorage.setItem(firstLoadKey, 'true');
        }

        let mcpEnabled = localStorage.getItem('mcpEnabled') === 'true';
        const appScript = mcpEnabled ? 'app-mcp.js' : 'app-original.js';

        console.log(`üì¶ Loading ${appScript} (MCP ${mcpEnabled ? 'ENABLED' : 'DISABLED'})`);

        const script = document.createElement('script');
        script.src = appScript;
        script.onerror = function() {
            console.error(`‚ùå Failed to load ${appScript}`);
            alert(`Error: Could not load ${appScript}. Please check that the file exists.`);
        };
        script.onload = function() {
            console.log(`‚úÖ ${appScript} loaded successfully`);
        };
        document.body.appendChild(script);
    </script>
</body>
</html>